---
title: "Manuscript additional Reports"
output:
  pdf_document:
    toc: yes
    toc_depth: 2
link-citations: yes
---
# Setup
```{r setup, }
#clear
  knitr::opts_chunk$set(echo=F, warning = F, message = F)
  source('P:\\flunm\\K1M\\flublok_pretrial\\flublok_pretrial_cfg.R')
  load(file='flublok_pretrial_sims.RData')
  library(kableExtra)
```

### Brown University   
### School of Public Health   
### Center for Gerontology  
### PI: Vincent Mor  

*Project started:* `r prj.StDate`  
*Documented created* `r Sys.time()`   
*Programmer:* `r prj.coder`  

# Load Cohort File  

```{r, message=F, warning=F}
filepath <- paste0(DataFiles, FileNames[[1, '1']])

df <- readRDS(filepath) %>%
  mutate(female = if_else(mds_gender=='Female', 1L, 0L),
         pcthmo = pcthmo / 100) %>%
  group_by(fac_id) %>%
  mutate(fac_fem = sum(female) / n(),
         fac_chrt_hosp = sum(dc_hosp_any) / n())

rw_title <- 'Base Cohort File'

des_df(df, rw_title, c('bene_id_18900', 'fac_id'))
```

# Cohort Information  

## Basic Cohort Information  
```{r }
n_fac <- n_distinct(df$hee_provn)

mn_ls <- df %>%
  group_by(fac_id) %>%
  summarize(n=n()) %>%
  ungroup() %>% pull(n) %>%
  mean(.) %>% round(.)
  
n_res <- n_distinct(df$bene_id_18900)
med_time <- round(median(df$hee_los), 1)
```

The cohort includes n=`r n_fac` facilities, with an average of `r mn_ls` residents. With n=`r n_res` residents evaluated at the time of 10/01/2017, and an average of `r med_time` days in the nursing home.  

## Table 1. Demographic Characteristics - Overall Facility  
```{r, }
tab_1_facvars <- c('fac_ls', 'fac_age_65', 'fac_age_85', 'fac_fem',
              'fac_black', 'fac_hispanic', 
              'fac_adl', 'fac_charlson', 
              'fac_dem', 'fac_resp',
              'fac_hosp_num', 'fac_chrt_hosp', 
              'pcthmo', 'dchrppd', 'lpnhrppd', 'agghighcfs', 'acuindex2')


tab_1_title <- 'Table 1. Baseline characteristics for overall facilities*'

df_fac <- df %>%
  select(tab_1_facvars) %>%
  group_by(fac_id) %>%
  mutate(fac_ls = n()) %>%
  ungroup() %>%
  distinct(.) %>%
  select(tab_1_facvars) %>%
  mutate_at(vars(-fac_ls, -fac_adl, -fac_charlson, -pcthmo, -dchrppd, -lpnhrppd, -agghighcfs, -acuindex2),
            list(~.*100))
  
n_ctrl <- nrow(df_fac)

tab_1_cnames <- c('Variable', paste0('Sites', ' (n=', n_ctrl, ')'))

vars_all <- names(df_fac)

var_lbls <- c('Avg. No. LS residents', '% Aged 65+', 
              '% Aged 85+', '% Female', '% Black', '% Hispanic',
              'Avg. ADL score', 'Avg. Charlson score',
              '% w/ Dementia', '% w/ Chronic Resp. illness',
              'Hosp. rate per person per year', 'Cohort Hospitalization Rate',
              '% HMO', 'Total Direct Care Hours / Person / Day',
              'LPN Hours / Person / Day', '% Admitted with High CFS', 'Acuity Index')


tab_1_new <- matrix(data="", ncol = 2, nrow = length(var_lbls))
tab_1_new[, 1] <- var_lbls #set labels to first col  
colnames(tab_1_new) <- tab_1_cnames

grp_1 <- df_fac[, tab_1_facvars] %>% #apply to vars  
  lapply(., cpt_func, digits=3) %>% unlist(.)  

tab_vals <- bind_rows(grp_1) %>%
  t(.)

### Insert subtitles
tab_1_new[, 2] <- tab_vals
kable(tab_1_new, row.names = F, escape=F, booktabs=T,  format="latex",
      align=c('l', rep('c',times=2))) %>%
  kable_styling(latex_options = "scale_down")
```

*Description.* We report facility aggregate statistics derived from MDS. Hosp. rate per person per year is for the entire NH population from previous OSCAR report. 

# Randomization Analysis  

## Important covariates  
```{r }
final.vars
```

## Variables with highest variability  

### Gather checking variables from Methods  
```{r, }
fct_lvls <- rndm_methods

for (i in 1:6) { #loop to create smd objects
  assign(paste0('m', i, '_smd'), get(paste0('m', i, '_res'))$smd %>%
     as.data.frame(.) %>%
    mutate(Method = fct_lvls[i]))
}

smd_all <- mget(ls()[str_detect(ls(), '_smd$')]) #get all objects with '_diff' names

smd_all <- bind_rows(smd_all) %>%
  mutate(Method = factor(Method, levels= fct_lvls)) %>%
  na.omit(.)

colnames(smd_all) <- c(chk_id_vars, 'Method')

smd_all_grp <- gather(smd_all, key = 'var', value = 'x', -Method) %>%
  mutate(var = factor(var, levels=chk_id_vars, labels = chk_id_lbls))
```

### Compute variance  

```{r }
sum_smd_grp <- smd_all_grp %>%
  group_by(Method, var) %>%
  summarize_all(var) 
```

### List of highest variation covariates  
```{r, }
highvar_cov <- sum_smd_grp %>%
  dplyr::filter(Method == 'Simple Randomizations') %>%
  arrange(desc(x)) %>%
  mutate(Variance = round(x, 4)) %>%
  select(-x) %>%
  rename(Covariate = var) %>%
  head(., 10) 

highvar_cov
```

```{r }
highvar_covs <- highvar_cov %>% pull(Covariate) %>% as.character(.)
```

## Variance reduction  

```{r, }
var_all_grp <- smd_all_grp %>%
  group_by(Method, var) %>%
  summarize(variance = var(x)) %>%
  pivot_wider(., id_cols = c(var), names_from = Method, values_from = variance)

for (i in 3:7) {
  var_all_grp[, i] <- (var_all_grp[, i] - var_all_grp[, 2]) / var_all_grp[, 2]
}

prvred <- var_all_grp[var_all_grp$var %in% highvar_covs, -2] 

prvred[nrow(prvred)+1, 2:6] <- colMeans(prvred[, 2:6])
prvred[nrow(prvred)+1, 2:6] <- sapply(prvred[, 2:6], min)
prvred[nrow(prvred)+1, 2:6] <- sapply(prvred[, 2:6], max)  

prvred_2 <- left_join(prvred, highvar_cov[,2:3], by=c('var'='Covariate')) %>%
  select(var, Variance, everything()) %>%
  arrange(desc(Variance)) %>%
  mutate_at(vars(-var), round, 3)
```

```{r, }
kable(prvred_2, row.names = F, escape=F, booktabs=T,  format="latex",
      align=c('l', rep('c',times=9))) %>%
  kable_styling(latex_options = "scale_down")
```

### Permutation Results  

```{r, }
for (i in 1:6) { #loop to create smd objects
  assign(paste0('m', i, '_diff'), get(paste0('m', i, '_res'))$delta %>%
     as.data.frame(.) %>%
    mutate(Method = fct_lvls[i]))
}

rtest_all <- mget(ls()[str_detect(ls(), '_rtest')]) #get all objects with '_smd' names

rtest_all <- bind_rows(rtest_all)
colnames(rtest_all) <- fct_lvls 

rtest_all_grp <- pivot_longer(rtest_all, cols = everything(), names_to = 'Method', values_to = 'x') %>%
  arrange(Method) %>%
  group_by(Method) %>%
  summarize(lci = quantile(x, probs = c(0.025)),
            uci = quantile(x, probs = c(0.975)),
            precision = 1/var(x)) %>%
  mutate_at(vars(-Method), round, 3)
```

```{r, }
kable(rtest_all_grp, row.names = F, escape=F, booktabs=T,  format="latex",
      align=c('l', rep('c',times=3))) %>%
  kable_styling(latex_options = "scale_down")
```